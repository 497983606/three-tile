# 1 总体架构思路

软件按照 threejs 思路对实现三维建模和渲染，即 Mesh+Loader 方式

瓦片地图，就是一个 LOD(Level Of Details)模型，与常规 LOD 模型不同的是：由于地图分级瓦片数量巨大，无法在创建时一次加载，所以需要在渲染过程中动态加载、创建、删除、销毁和渲染。

> LOD：（Level of Details），简称为多细节层次。LOD 根据模型的节点在显示环境中所处的位置(Screen Size)和重要度，来决定物体渲染的资源分配，降低非重要物体的面数和细节数，从而获得高效率的渲染计算。

1.1 结构：

-   瓦片类，保存瓦片坐标、矩阵、Mesh 等瓦片信息。
-   用一个四叉树保存各瓦片，并根据摄像机与瓦片距离动态更新。
-   瓦片加载器，实现根据瓦片坐标加载瓦片数据并返回 Mesh。对不同格式瓦片，使用不同加载器进行瓦片 Mesh 的创建。
-   瓦片容器，即地图 Mesh，对瓦片进行调度管理，根据瓦片树加载瓦片

1.2 流程
    在瓦片容器渲染过程中完成：

-   根据摄像机与瓦片的距离更新瓦片树
-   根据瓦片树使用 Loader 加载并创建瓦片 Mesh
-   将瓦片树上各瓦片 Mesh 加入地图容器中

1.3 代码风格
    在三维模型方面，代码沿用threejs风格，即Mesh/Geometry/Material/Texture/Loader组合。
    编码风格上，使用接口/抽象类/组合等模式，三种解耦方式混合，用户可根据自己习惯采用不同方式扩展。
    
# 2 目前存在的问题

2.1 瓦片数据格式扩展问题

    看了太多的gis软件架构，three-tile模仿它们写了Provider类，用于定义不同类型地图数据源。
    又参考了threejs中的模型加载方式，写了Loader来加载数据。Loader调用Provider取得瓦片Url生成几何体和材质再传入瓦片Mesh。
    原本打算只支持两种格式地图数据，图像格式的影像和图像格式的地形，但完成后感觉还有以下缺点：

    * 图像各省的影像图，对地名、道路等数据的渲染效果很差，需要支持用矢量瓦片。
    * 地图数据扩展性很差，因为一副地图只有一个Loader，难以同时加载不同格式的地图数据。要支持需要修改Loader代码。

    计划：
    将Loader并入Provider类，即每一个Provider均有自己的Loader。
    缺点是：Provider类变得很复杂，扩展Provider需要考虑的情况更多

2.2 瓦片四叉树结构修改

    当时为了简单，没有自己定义四叉树结构，直接使用了Mesh，虽然代码简单了，但存在以下缺点：
    * 四叉树节点由Mesh组成，即使该Mesh是父瓦片不显示也需要保存，浪费了内存
    * 由于瓦片Mesh在瓦片树更新时已创建，Loader加载数据时只能是加载纹理和几何体然后赋给Mesh，有些怪异

    计划：
    重写瓦片节点类，重写四叉树，重写LOD逻辑
    重写Loader，直接返回Mesh
    问题：颠覆性改变，工作量太大，暂不打算改了

2.3 取地面高度数据效率低

    目前使用射线法来取得指定点地面高度数据，效率较低，造成以下问题：
    * 点状元素贴地困难：因不同级别瓦片高程的精度不一样，在地图上添加几何体时取得地面高程十分不准确，在缩放后几何体无法准确贴地，原计划是在每次加载完数据都重写读取一次地面高度，但经测试，当添加大量元素到地图上后，取高度时画面会出现卡顿，此方法貌似不可行。
    * 几何体难以无法贴地：面、线几何体贴地无法实现，考虑使用深度缓存来解决，目前还未完成。

2.4 瓦片存在接缝

    虽然网上有不是文献从理论上描述了解决瓦片接缝的方案，但缺少实际可行性，或者算法过于复杂
    three-tile使用了带裙边的几何体方式解决瓦片接缝问题，包括cesium等三维地图均使用此方案。
    几何体加裙边方式，只是掩盖了瓦片接缝，并未真正抹平接缝，但算法简单，效果也还不错。
    只是three-tile未能实现裙边处法向量计算，添加直射光照后，在地形起伏较大的雪地，还是有明显的条纹。

    计划：
    使用MapBox的Terrain-DEM格式瓦片来解决。难度较大，暂未实现

2.5 地形网格效率还有提升空间

    three-tile地形网格使用了简单的矩形网格，算法简单速度很快
    但由于矩形网格过于简单，不能根据地形起伏程度精简顶点

    计划：
    使用MARTINI算法创建地形（https://github.com/mapbox/martini）
    目前不知道该算法对渲染速度影响有多大，可能会出现卡顿

2.6 地图抖动问题

    由于不同级别地形的精度不同，在计算瓦片离摄像机距离时可能会产生抖动现象，即不停地在高地级别瓦片切换。所幸这种情况极少出现。
    但从理论上说，只要地图数据某点的在不同级别瓦片高程差异很大时就有可能出现。比如在某点第16级瓦片高程为5000米，而在17级瓦片该点高程为1000米，那么在对瓦片做LOD时，计算该点到摄像机的距离，16级发现需要放大瓦片加载17级瓦片，而17级瓦片加载后距离又较小，又需要缩小瓦片加载16级，如此反复加载造成瓦片抖动。

    计划：已解决

2.7 z-fighting 问题

    由于瓦片地图摄像机的near-far差异巨大，很容易出现z-fighting现象，即因深度舍入误差造成画面破碎
    目前已通过动态调整near-far值尽量减少，但无法避免。
    造成的影响是：在放置在贴近地面的无题在距离极远处观察时会出现破碎和闪烁。

    彻底解决只有一种方案，使用多次离屏渲染叠加显示。
    但three-tile仅打算提供一个三维地图模型，并不打算接管整个三维场景，采用离屏渲染破坏了整体架构
